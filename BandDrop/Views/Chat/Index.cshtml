@model BandDrop.ViewModels.AudioFileVM
<!DOCTYPE html>
<html>
<head>
    <title>pChat &mdash; Private Chatroom</title>
    <script src="https://js.pusher.com/4.1/pusher.min.js"></script>
    <script src="https://connect.soundcloud.com/sdk/sdk-3.3.0.js"></script>
    <script>
        $(document).ready(function () {
            let currentContact = null; // Holds current contact
            let currentconversationChannel = null;
            let conversationChannelName = null;
            let newMessageTpl =
                `<li class="list-group-item " >
                  <div id="msg-{{id}}" class="row __chat__par__ ">
                    <div class="__chat__  " style="width: 18rem;">
                     <h5 class="card-header text-info">{{name}}</h5>
                     <p class="text-primary pl-4">{{body}}</p>
                    </div>
                 </div>
                </li>`;
            let newMessageTplContact =
                `<li class="list-group-item " >
                  <div id="msg-{{id}}" class="row __chat__par__ ">
                    <div class="__chat__  " style="width: 18rem;">
                     <h5 class="card-header text-info text-left">{{name}}</h5>
                     <p class="text-primary pl-4 bg-light">{{body}}</p>
                    </div>
                 </div>
                </li>`;
            const pusher = new Pusher('de9851a0744ee8227c97', {
                authEndpoint: '@Url.Action("AuthForChannel", "Auth")',
                cluster: 'us2'
            });
            pusher.connection.bind('connected', function () {
                socketId = pusher.connection.socket_id;
            });

            $(".user__item").click(function (e) {
                e.preventDefault();
                currentContact = {
                    id: $(this).data('contact-id'),
                    name: $(this).data('contact-name'),
                };

                if (conversationChannelName) {
                    pusher.unsubscribe(conversationChannelName);
                }

                conversationChannelName = getConvoChannel(
                    (@ViewBag.currentUser.id * 1),
                    (currentContact.id * 1)
                );

                currentconversationChannel = pusher.subscribe(conversationChannelName);

                bind_client_events();

                $('#contacts').find('li').removeClass('active');

                $('#contacts .contact-' + currentContact.id).find('li').addClass('active');
                getChat(currentContact.id);
            });
            function getConvoChannel(user_id, contact_id) {
                if (user_id > contact_id) {
                    return 'private-chat-' + contact_id + '-' + user_id;
                }

                return 'private-chat-' + user_id + '-' + contact_id;
            }

            $('#sendMessage').on('click', function () {
                $.post('@Url.Action("SendMessage", "Chat")', {
                    message: $('#msg_box').val(),
                    contact: currentContact.id,
                    socket_id: socketId,
                }).done(function (data) {
                    //display the message immediately on the view of the sender
                    displayMessage(data);
                    $('#msg_box').val('');
                });
            });






            // get chat data
            function getChat(contact_id) {
                var link = '@Url.Action("Conversations", "Chat")/';
                var object = new Object();
                object.id = contact_id
                $.ajax({
                    type: "GET",
                    url: link,
                    data: object,
                    dataType: "json"
                })

                    .done(function (resp) {
                        var chat_data = resp.data || [];
                        loadChat(chat_data);
                    });
            }

            //load chat data into view
            function loadChat(chat_data) {

                chat_data.forEach(function (data) {

                    displayMessage(data);
                });

                $('.chat__body').show();
                $('.__no__chat__').hide();
            }

            function displayMessage(message_obj) {
                const msg_id = message_obj.id;
                const msg_body = message_obj.message;
                const msg_name = message_obj.sender_name;
                const msg_time = message_obj.created_at;

                let template = $(newMessageTpl).html();

                template = template.replace("{{id}}", msg_id);
                template = template.replace("{{body}}", msg_body);
                template = template.replace("{{name}}", msg_name);

                // need to properly format before use
                //template = template.replace("{{time}}", msg_time);

                template = $(template);

                if (message_obj.sender_id == @ViewBag.currentUser.id ) {
                    template.find('.__chat__').addClass('.from__chat');
                } else {
                    template.find('.__chat__').addClass('.receive__chat');
                }

                if (message_obj.status == 1) {
                    template.find('.delivery-status').show();
                }

                $('.chat__main').append(template);
            }
            function bind_client_events() {
                currentconversationChannel.bind("client-is-typing", function (data) {
                    if (data.user_id == currentContact.id &&
                        data.contact_id == @ViewBag.currentUser.id  ) {

                        $('#typerDisplay').text(currentContact.name + ' is typing...');

                        $('.chat__typing').fadeIn(100, function () {
                            $('.chat__type__body').addClass('typing_display__open');
                        }).delay(1000).fadeOut(300, function () {
                            $('.chat__type__body').removeClass('typing_display__open');
                        });
                    }
                });
                currentconversationChannel.bind("new_message", function(msg) {
                if ( msg.receiver_id == @ViewBag.currentUser.id ) {
                    displayMessage(msg);
                }
                });
                currentconversationChannel.bind("message_delivered", function (msg) {
                    $('#msg-' + msg.id).find('.delivery-status').show();
                });
            }
         //User is typing
            var isTypingCallback = function () {
                currentconversationChannel.trigger("client-is-typing", {
                    user_id: @ViewBag.currentUser.id,
                    contact_id: currentContact.id,
                });
            };

            $('#msg_box').on('keyup', isTypingCallback);
        });
        $("#out").animate({ scrollTop: $(document).height() }, "fast");

        // soundcloud implementation


     
    </script>
    @*<script type="text/javascript">

        $(document).ready(function () {
            $('#dataTable').DataTable();

            $("audio").on("play", function () {
                $("audio").not(this).each(function (index, audio) {
                    audio.pause();
                });
            });
        });
    </script>*@
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-inverse shadow pl-0 ml-0 mr-3">
        <div class="container-fluid"  style="display: flex; height: 100%; overflow: hidden;">
            <div class="navbar-header text-primary">
                <a class="navbar-brand" href="#">@ViewBag.currentUser.BandName - @ViewBag.currentUser.name </a>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#">Log Out</a></li>
            </ul>
        </div>
    </nav>
    <!-- / Navigation Bar -->
    <div class="container position-relative w-100 pt-4" >
        <div class="row mw-100 h-100">
            <div class="col-xs-12 col-md-3" style="height: 50vh; width: 100%;">
                <aside class="main visible-md visible-lg" style="height: 100%">
                    @*<div class="row pr-2" style="height: 100%">*@
                        <div class="panel shadow w-100 h-100" style="width: 15rem;">
                            <div class="panel panel-default users__bar bg-primary">
                                <div class="panel-heading users__heading text-primary card-header">
                                    <h4 class="text-white">Contacts (@ViewBag.allUsers.Count)</h4>
                                </div>
                                <div class="__no__chat__ bg-light">
                                    <p class="text-primary pl-2 pt-1">Select bandmate</p>
                                </div>
                                <a class="users__body">
                                    <ul id="contacts" class="list-group mh-80">
                                        @foreach (var user in @ViewBag.allUsers)
                                        {
                                          <a class="user__item contact-@user.id text-info pl-3 list-group-item" href="#" data-contact-id="@user.id" data-contact-name="@user.name">
                                             <li class="list-group-item-secondary shadow-sm">
                                                 <span class="list-group-item shadow-sm text-dark card-text">@user.name</span>
                                                     <div class="status-bar"></div>
                                             </li>
                                           </a>
                                         }
                                    </ul>    
                                </a>
                            </div>
                        </div>
                    @*</div>*@
            </aside>
        </div>
    <div class="col-xs-12 mw-100 col-md-4 chat__body pl-1 pr-4 pb-0 shadow" style="flex-grow: 1; overflow-y: auto; height: 50vh">
        <div class="card-group small-shadow rounded">
            <ul class="list-group list-group-flush chat__main d-inline-flex w-100"></ul>
        </div>
        <aside class="chat__type__body">
            <div class="chat__type position-fixed">
                <textarea id="msg_box"   placeholder="Type your message"></textarea>
                <button class="btn btn-primary" id="sendMessage">Send</button>
            </div>
        </aside>
        <div class="chat__typing">
            <span id="typerDisplay"></span>
        </div>
    </div>
        <div class="col-xs-12 col-md-5 mw-100">
            <table id="dataTable" class="table table-bordered table-striped">
                <thead class="thead-dark">
                    <tr>
                        <th>Name</th>
                        <th>Play Audio</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var item in ViewBag.Songs)
                 {
                <tr>
                  <td>@item.Name</td>
                     <td>
                        <audio controls>
                            <source src="@Url.Content(@item.FilePath)" type="audio/ogg">
                        </audio>
                     </td>
                </tr>
                }
                 </tbody>
            </table>
                  <div class="panel pl-4 shadow w-100 h-100" style="flex-grow: 1; overflow-y: auto;">
                      @using (Html.BeginForm("UploadAudio", "AudioFiles", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {

              <div class="form-group">
                  <div class="custom-file panel-text">
                      @Html.LabelFor(a => a.File, "Audio track", htmlAttributes: new { @class = "control-label col-md-2" })
                  </div>
                  <div class="col-md-2">
                      @Html.TextBoxFor(a => a.File, new { type = "file", @class = "btn-secondary" })
                  </div>
                  <div class="form-group">
                      @Html.LabelFor(a => a.Name, htmlAttributes: new { @class = "control-label col-md-2" })
                      <div class="col-md-2">
                          @Html.EditorFor(a => a.Name, new { htmlAttributes = new { @class = "form-control" } })
                          @Html.ValidationMessageFor(a => a.Name, "", new { @class = "text-danger" })
                      </div>
                  </div>
                  <br>
                  <div class="input-group-append">
                      <input type="submit" id="btnUpload" class="btn btn-secondary" value="Upload" />
                  </div>

              </div>
}
                  </div>

              </div>
          
       </div>
    </div>
</body>
</html>

